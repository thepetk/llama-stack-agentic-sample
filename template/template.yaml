apiVersion: scaffolder.backstage.io/v1beta3
# https://backstage.io/docs/features/software-catalog/descriptor-format#kind-template
kind: Template
metadata:
  name: llama-stack-agentic
  title: Llama Stack Agentic AI Workflow
  description: |
    Deploy a sophisticated AI Agentic Workflow application that provides an intelligent 
    chat interface with dynamic, stateful workflow orchestration using LangGraph and 
    Llama Stack. Features multi-agent routing, RAG-powered responses, Kubernetes 
    integration via MCP, and content safety guardrails.
  tags: ["ai", "llama-stack", "langgraph", "mcp", "rag", "agents", "kubernetes", "streamlit"]
  annotations:
    backstage.io/techdocs-ref: dir:.
spec:
  type: service
  owner: rhdh-pai
  parameters:
    # ==================== Application Information ====================
    - title: Application Information
      required:
        - name
        - owner
        - argoNS
        - argoInstance
        - argoProject
      ui:order:
        - name
        - owner
        - argoNS
        - argoInstance
        - argoProject
        - includeArgoLabel
        - argoAppLabel
        - '*'
      properties:
        name:
          title: Name
          type: string
          description: Unique name of the component
          ui:autofocus: true
          ui:field: EntityNamePicker
          maxLength: 63
        owner:
          title: Owner
          type: string
          description: Owner of the component
          default: user:guest
          ui:field: OwnerPicker
          ui:options: {}
        argoNS:
          title: ArgoCD Namespace
          type: string
          description: The target namespace of the ArgoCD deployment
          default: openshift-gitops
          maxLength: 63
        argoInstance:
          title: ArgoCD Instance
          type: string
          description: The target ArgoCD instance name
          default: default
          maxLength: 63
        argoProject:
          title: ArgoCD Project
          type: string
          description: The target ArgoCD project name
          default: default
          maxLength: 63
        includeArgoLabel:
          title: Include ArgoCD App Label?
          type: boolean
          description: Include a user provided ArgoCD Application Label
          default: true
      dependencies:
        includeArgoLabel:
          oneOf:
            - required:
                - argoAppLabel
              properties:
                includeArgoLabel:
                  const: true
                argoAppLabel:
                  title: ArgoCD Application Label
                  type: string
                  description: Label RHDH uses to identify ArgoCD Applications
                  default: rolling-demo

    # ==================== Llama Stack Configuration ====================
    - title: Llama Stack Configuration
      description: Configure the Llama Stack AI inference server.
      required:
        - vllmUrl
      ui:order:
        - vllmUrl
        - safetyModel
        - '*'
      properties:
        vllmUrl:
          title: vLLM Server URL
          type: string
          description: URL of the vLLM inference server endpoint
          ui:help: "Example: https://your-vllm-server.apps.cluster.example.com/v1"
        safetyModel:
          title: Safety Model (SAFETY_MODEL)
          type: string
          default: ollama/llama-guard3:8b
          description: Model for content safety guardrails
          ui:help: "Optional - Default: ollama/llama-guard3:8b"

    # ==================== Application Configuration ====================
    - title: Application Configuration
      description: Configure the Streamlit AI application.
      required:
        - inferenceModel
        - mcpToolModel
        - githubRepoUrl
      ui:order:
        - inferenceModel
        - mcpToolModel
        - githubRepoUrl
        - '*'
      properties:
        inferenceModel:
          title: Inference Model (INFERENCE_MODEL)
          type: string
          description: Model ID for classification and inference
          ui:help: "Example: vllm/redhataiqwen3-8b-fp8-dynamic"
        mcpToolModel:
          title: MCP Tool Model (MCP_TOOL_MODEL)
          type: string
          description: Model for MCP Kubernetes tool calls (must support function calling)
          ui:help: "Example: vllm/redhataiqwen3-8b-fp8-dynamic"
        githubRepoUrl:
          title: GitHub Repository URL (GITHUB_URL)
          type: string
          description: Target repository for the GitHub MCP Tool for issue creation and commenting
          ui:help: "Example: https://github.com/your-org/your-repo"

    # ==================== Repository Information ====================
    - title: Application Repository Information
      description: Configure where your application repositories will be created. Two repositories will be generated based on your settings.
      required:
        - hostType
        - repoOwner
        - repoName
        - branch
      properties:
        hostType:
          title: Host Type
          type: string
          enum:
            - GitHub
            - GitLab
          default: GitHub
        repoOwner:
          title: Repository Owner
          type: string
          ui:help: The organization, user or project that this repo will belong to
          default: ai-rolling-demo
        repoName:
          title: Repository Name
          type: string
          description: "Creates two repos: {name} (source code for building/deploying) and {name}-gitops (Kubernetes manifests synced by ArgoCD)"
          ui:help: "Example: my-ai-app creates my-ai-app and my-ai-app-gitops"
        branch:
          title: Repository Default Branch
          type: string
          default: main
      dependencies:
        hostType:
          oneOf:
            - required:
                - githubServer
              properties:
                hostType:
                  const: GitHub
                githubServer:
                  title: Repository Server
                  type: string
                  default: github.com
                  ui:help: "On-prem example: github.apps.cluster.example.com"
            - required:
                - gitlabServer
              properties:
                hostType:
                  const: GitLab
                gitlabServer:
                  title: Repository Server
                  type: string
                  default: gitlab.com
                  ui:help: "On-prem example: gitlab.apps.cluster.example.com"

    # ==================== Namespace and Secrets Configuration ====================
    - title: Namespace and Secrets Configuration
      description: |
        Configure the deployment namespace and required Kubernetes Secrets.
        All secrets must exist in the specified namespace. See TechDocs Usage page under "Required Secrets" for examples.
      required:
        - namespace
        - llamaStackSecretName
        - appSecretName
        - cicdCredentialsSecretName
        - secretsAcknowledgment
      ui:order:
        - namespace
        - llamaStackSecretName
        - appSecretName
        - cicdCredentialsSecretName
        - secretsAcknowledgment
        - '*'
      properties:
        namespace:
          title: Deployment Namespace
          type: string
          description: Kubernetes namespace where the application and secrets will be deployed
          ui:help: "Example: rhdh-app"
          default: rhdh-app
        llamaStackSecretName:
          title: Llama Stack Secrets Name
          type: string
          default: llama-stack-secrets
          description: |
            • VLLM_API_KEY - API key for vLLM inference server
            • OPENAI_API_KEY - OpenAI API key for embeddings and inference
        appSecretName:
          title: Application Secrets Name
          type: string
          default: app-secrets
          description: |
            • GITHUB_TOKEN - GitHub PAT with 'repo' scope for issue creation via GitHub MCP Tool
        cicdCredentialsSecretName:
          title: CI/CD Credentials Secret Name
          type: string
          default: cicd-credentials
          description: |
            • GIT_TOKEN - PAT for Tekton pipeline GitOps operations
            • WEBHOOK_SECRET - Webhook secret for Pipelines as Code (GitHub/GitLab)
            • QUAY_DOCKERCONFIGJSON - Docker config for pushing images to registry
        secretsAcknowledgment:
          title: I confirm the secrets exist or will be created in the specified namespace
          type: boolean
          default: false
          ui:widget: checkbox
      dependencies:
        secretsAcknowledgment:
          oneOf:
            - properties:
                secretsAcknowledgment:
                  const: true

    # ==================== Deployment Information ====================
    - title: Deployment Information
      required:
        - imageRegistry
        - imageOrg
        - imageName
      ui:order:
        - imageRegistry
        - imageOrg
        - imageName
        - '*'
      properties:
        imageRegistry:
          title: Image Registry
          type: string
          description: The container image registry host
          default: quay.io
          ui:help: "On-prem example: quay.apps.cluster.example.com"
        imageOrg:
          title: Image Organization
          type: string
          description: The organization, user or project for container images
          default: rhdhpai-rolling-demo
        imageName:
          title: Image Name
          type: string
          description: Name for the container image

  # ==================== Template Steps ====================
  steps:
    # -------------------- SOURCE REPOSITORY --------------------
    # Fetch application source code
    - id: fetch-src
      name: Fetch Source Code
      action: fetch:plain
      input:
        url: ../src
        targetPath: source/src

    # Fetch configuration files
    - id: fetch-config
      name: Fetch Config
      action: fetch:plain
      input:
        url: ../config
        targetPath: source/config

    # Fetch main application entry point
    - id: fetch-streamlit-app
      name: Fetch Streamlit App
      action: fetch:plain:file
      input:
        url: ../streamlit_app.py
        targetPath: source/streamlit_app.py

    # Fetch container build files
    - id: fetch-containerfile
      name: Fetch Containerfile
      action: fetch:plain:file
      input:
        url: ../Containerfile
        targetPath: source/Containerfile

    # Fetch dependency files
    - id: fetch-pyproject
      name: Fetch PyProject
      action: fetch:plain:file
      input:
        url: ../pyproject.toml
        targetPath: source/pyproject.toml

    - id: fetch-uv-lock
      name: Fetch UV Lock
      action: fetch:plain:file
      input:
        url: ../uv.lock
        targetPath: source/uv.lock

    # Fetch license file (required by Containerfile)
    - id: fetch-license
      name: Fetch License
      action: fetch:plain:file
      input:
        url: ../LICENSE
        targetPath: source/LICENSE

    # Renders all of the template variables into the techdocs
    - id: fetch-skeleton-docs
      name: Fetch Skeleton Techdocs
      action: fetch:template
      input:
        url: ../skeleton/techdoc
        targetPath: source
        values:
          name: ${{ parameters.name }}
          namespace: ${{ parameters.namespace }}
          repoURL: https://${{ parameters.githubServer if parameters.hostType === 'GitHub' else parameters.gitlabServer }}/${{ parameters.repoOwner }}/${{ parameters.repoName }}-gitops
          srcRepoURL: https://${{ parameters.githubServer if parameters.hostType === 'GitHub' else parameters.gitlabServer }}/${{ parameters.repoOwner }}/${{ parameters.repoName }}
          appContainer: quay.io/redhat-ai-dev/agentic-sample:latest
          appPort: 8501
          inferenceModel: ${{ parameters.inferenceModel }}
          guardrailModel: ${{ parameters.guardrailModel }}
          mcpToolModel: ${{ parameters.mcpToolModel }}

    # Renders all the template variables into the files (catalog-info.yaml, .tekton/)
    - id: fetch-skeleton
      name: Fetch Skeleton
      action: fetch:template
      input:
        url: ../skeleton/source-repo
        targetPath: source
        values:
          name: ${{ parameters.name }}
          namespace: ${{ parameters.namespace }}
          description: Llama Stack Agentic AI Workflow Application
          dockerfile: Containerfile
          buildContext: .
          gitopsSecretName: ${{ 'gitops-auth-secret' if parameters.hostType === 'GitHub' else 'gitlab-auth-secret' }}
          image: '${{ parameters.imageRegistry }}/${{ parameters.imageOrg }}/${{ parameters.imageName }}'
          tags: '["ai", "llama-stack", "langgraph", "mcp", "rag", "agents"]'
          owner: ${{ parameters.owner }}
          repoSlug: '${{ parameters.imageOrg }}/${{ parameters.imageName }}'
          defaultBranch: ${{ parameters.branch }}

    # Fetch GitHub Action for automerge (if GitHub)
    - id: fetch-github-action
      name: Fetch GitHub Action
      action: fetch:plain
      if: ${{ parameters.hostType === 'GitHub' }}
      input:
        targetPath: source
        url: ../skeleton/github-action

    # Publish source repository to GitHub
    - id: publish-github
      name: Publish Repository to GitHub
      action: publish:github
      if: ${{ parameters.hostType === 'GitHub' }}
      input:
        sourcePath: source
        description: Llama Stack Agentic AI Workflow - ${{ parameters.name }}
        repoUrl: ${{ parameters.githubServer }}?owner=${{ parameters.repoOwner }}&repo=${{ parameters.repoName }}
        defaultBranch: ${{ parameters.branch }}
        protectDefaultBranch: true
        allowAutoMerge: true
        deleteBranchOnMerge: true
        requiredStatusCheckContexts: []
        repoVisibility: "public"
        requiredApprovingReviewCount: 0

    # Publish source repository to GitLab
    - id: publish-gitlab
      name: Publish Repository to GitLab
      action: publish:gitlab
      if: ${{ parameters.hostType === 'GitLab' }}
      input:
        sourcePath: source
        description: Llama Stack Agentic AI Workflow - ${{ parameters.name }}
        repoUrl: ${{ parameters.gitlabServer }}?owner=${{ parameters.repoOwner }}&repo=${{ parameters.repoName }}
        defaultBranch: ${{ parameters.branch }}
        protectDefaultBranch: false
        repoVisibility: "public"

    # -------------------- GITOPS REPOSITORY --------------------
    # Fetch GitOps skeleton (includes app-of-apps, catalog-info, components/http/base and overlays)
    - id: fetch-gitops-skeleton
      name: Fetch Gitops Skeleton
      action: fetch:template
      input:
        url: ../skeleton/gitops-template
        targetPath: gitops
        values:
          name: ${{ parameters.name }}
          appName: ${{ parameters.name }}-gitops
          description: GitOps manifest for Llama Stack Agentic - ${{ parameters.name }}
          namespace: ${{ parameters.namespace }}
          rhdhNamespace: rolling-demo-ns
          repoURL: https://${{ parameters.githubServer if parameters.hostType === 'GitHub' else parameters.gitlabServer }}/${{ parameters.repoOwner }}/${{ parameters.repoName }}-gitops
          srcRepoURL: https://${{ parameters.githubServer if parameters.hostType === 'GitHub' else parameters.gitlabServer }}/${{ parameters.repoOwner }}/${{ parameters.repoName }}
          argoComponentOverlays: './components/${{ parameters.name }}/overlays'
          owner: ${{ parameters.owner }}
          argoNS: ${{ parameters.argoNS }}
          argoProject: ${{ parameters.argoProject }}
          secretRef: ${{ parameters.hostType === 'GitLab' }}
          gitSecret: gitlab-auth-secret
          gitSecretKey: password
          webhookSecret: pipelines-secret
          webhookSecretKey: webhook.secret
          defaultBranch: main
          # Application container image
          appContainer: quay.io/redhat-ai-dev/agentic-sample:latest
          llamaStackContainer: quay.io/redhat-ai-dev/agentic-llama-stack:latest
          appPort: 8501
          # Llama Stack configuration
          vllmUrl: ${{ parameters.vllmUrl }}
          safetyModel: ${{ parameters.safetyModel }}
          llamaStackSecretName: ${{ parameters.llamaStackSecretName }}
          # Application configuration
          inferenceModel: ${{ parameters.inferenceModel }}
          mcpToolModel: ${{ parameters.mcpToolModel }}
          githubRepoUrl: ${{ parameters.githubRepoUrl }}
          appSecretName: ${{ parameters.appSecretName }}
          # Provider flags (vLLM and OpenAI always enabled for this template)
          vllmEnabled: true
          openaiEnabled: true
          # Pipeline/Deployment configuration
          cicdCredentialsSecretName: ${{ parameters.cicdCredentialsSecretName }}
          # Image configuration
          imageRegistry: ${{ parameters.imageRegistry }}
          imageOrg: ${{ parameters.imageOrg }}
          imageName: ${{ parameters.imageName }}
          # App support
          supportApp: true

    # Rename component directory from http to the app name
    - action: fs:rename
      id: renameComponentDir
      name: Rename Component Directory
      input:
        files:
          - from: gitops/components/http
            to: gitops/components/${{ parameters.name }}
            overwrite: true

    # Publish GitOps repository to GitHub
    - id: publish-github-gitops
      name: Publish GitOps Repository to GitHub
      action: publish:github
      if: ${{ parameters.hostType === 'GitHub' }}
      input:
        sourcePath: gitops
        description: GitOps repository for Llama Stack Agentic - ${{ parameters.name }}
        repoUrl: ${{ parameters.githubServer }}?owner=${{ parameters.repoOwner }}&repo=${{ parameters.repoName }}-gitops
        defaultBranch: "main"
        protectDefaultBranch: false
        repoVisibility: "public"

    # Publish GitOps repository to GitLab
    - id: publish-gitlab-gitops
      name: Publish GitOps Repository to GitLab
      action: publish:gitlab
      if: ${{ parameters.hostType === 'GitLab' }}
      input:
        sourcePath: gitops
        description: GitOps repository for Llama Stack Agentic - ${{ parameters.name }}
        repoUrl: ${{ parameters.gitlabServer }}?owner=${{ parameters.repoOwner }}&repo=${{ parameters.repoName }}-gitops
        defaultBranch: "main"
        protectDefaultBranch: false
        repoVisibility: "public"

    # -------------------- REGISTRATION & ARGOCD --------------------
    # Wait for repository availability
    - id: wait-for-github-repository
      name: Waiting for Repository Availability
      action: 'debug:wait'
      input:
        seconds: 3

    # Register source repository
    - id: register
      name: Register
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['publish-github'].output.repoContentsUrl if steps['publish-github'].output else steps['publish-gitlab'].output.repoContentsUrl }}
        catalogInfoPath: '/catalog-info.yaml'

    # Register GitOps repository
    - id: register-gitops
      name: Register Gitops
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['publish-github-gitops'].output.repoContentsUrl if steps['publish-github-gitops'].output else steps['publish-gitlab-gitops'].output.repoContentsUrl }}
        catalogInfoPath: '/catalog-info.yaml'

    # Create ArgoCD resources
    - id: create-argocd-resources
      name: Create ArgoCD Resources
      action: argocd:create-resources
      input:
        appName: ${{ parameters.name }}-app-of-apps
        argoInstance: ${{ parameters.argoInstance }}
        namespace: ${{ parameters.argoNS }}
        labelValue: rolling-demo
        repoUrl: https://${{ parameters.githubServer if parameters.hostType === 'GitHub' else parameters.gitlabServer }}/${{ parameters.repoOwner }}/${{ parameters.repoName }}-gitops.git
        path: './app-of-apps'

    # PR to trigger pipeline build (GitHub only)
    - id: trigger-build-pr
      name: PR to Trigger Pipeline Build
      action: publish:github:pull-request
      if: ${{ parameters.hostType === 'GitHub' }}
      input:
        repoUrl: ${{ parameters.githubServer }}?owner=${{ parameters.repoOwner }}&repo=${{ parameters.repoName }}
        branchName: trigger-pipeline
        commitMessage: trigger pipeline build
        description: "PR to trigger pipeline build"
        title: trigger pipeline build
        sourcePath: source
        targetBranchName: ${{ parameters.branch }}

    # Dispatch GitHub workflow to automerge
    - id: trigger_gh_workflow
      name: Trigger GitHub workflow
      action: github:actions:dispatch
      if: ${{ parameters.hostType === 'GitHub' }}
      input:
        repoUrl: ${{ parameters.githubServer }}?owner=${{ parameters.repoOwner }}&repo=${{ parameters.repoName }}
        branchOrTagName: ${{ parameters.branch }}
        workflowId: automerge.yml
        workflowInputs: {pr_url: "${{ steps['trigger-build-pr'].output.remoteUrl }}"}

  # ==================== Output Links ====================
  output:
    links:
      - title: Source Repository
        url: ${{ steps['publish-github'].output.remoteUrl if steps['publish-github'].output else steps['publish-gitlab'].output.remoteUrl }}
      - title: GitOps Repository
        url: ${{ steps['publish-github-gitops'].output.remoteUrl if steps['publish-github-gitops'].output else steps['publish-gitlab-gitops'].output.remoteUrl }}
      - title: Open Component in Catalog
        icon: catalog
        entityRef: ${{ steps['register'].output.entityRef }}
      - title: Open GitOps Resource in Catalog
        icon: catalog
        entityRef: ${{ steps['register-gitops'].output.entityRef }}
